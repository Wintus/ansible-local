---

- name: install iBus with Mozc
  become: yes
  block:
    - name: install iBus
      package:
        name: ibus

    - name: install iBus Mozc
      package:
        name: ibus-mozc
  rescue:
    - name: skip become
      debug:
        msg: skip install

- name: add keybindings to on/off ja
  vars:
    dconf_key: /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings
    dconf_dir: /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings
  block:
    - name: add keybinding to turn on ja
      dconf:
        key: "{{ dconf_dir }}/ibus-mozc-on/{{ item.key }}"
        value: "{{ item.value | to_json }}"
      changed_when: no
      with_items:
        - key: name
          value: ibus mozc on
        - key: command
          value: ibus engine 'mozc-jp'
        - key: binding
          value: <SUPER>j

    - name: add keybinding to turn off ja
      dconf:
        key: "{{ dconf_dir }}/ibus-mozc-off/{{ item.key }}"
        value: "{{ item.value | to_json }}"
      changed_when: no
      with_items:
        - key: name
          value: ibus mozc off
        - key: command
          value: ibus engine 'xkb:us::eng'
        - key: binding
          value: <SUPER>e

    - name: read custom keybindings
      dconf:
        key: "{{ dconf_key }}"
        state: read
      register: dconf_read

    - name: register custom keybindings
      dconf:
        key: "{{ dconf_key }}"
        value: "{{ merged }}"
      vars:
        current: "{{ dconf_read.value | from_yaml | default([], true) }}"
        adding:
          - "{{ dconf_dir }}/ibus-mozc-on/"
          - "{{ dconf_dir }}/ibus-mozc-off/"
        merged: "{{ current | union(adding) }}"
      changed_when: merged | difference(current)
