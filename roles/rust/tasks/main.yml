---

- name: install rust by script
  vars:
    installer: /tmp/rust-installer.sh
  block:
  - name: download installer
    get_url:
      url: https://sh.rustup.rs/
      dest: "{{ installer }}"

  - name: install rust
    script: "{{ installer }} -y"
    register: install
    changed_when: "'existing' not in install.stderr"

  - name: enable path
    shell: . ~/.cargo/env
    when: "'existing' not in install.stderr"

- name: install rust by apt
  when: ansible_pkg_mgr == "apt"
  become: yes
  apt:
    name: "{{ item }}"
  with_items:
    - rustc
    - cargo

- name: install depedency of exa
  package:
    name: cmake
  become: yes

- name: "install tools by cargo"
  shell: "cargo install {{ item.crate | default(item.name) }}"
  register: cargo_install
  vars:
    installed: 101
  failed_when: cargo_install.rc not in [0, installed]
  changed_when: cargo_install.rc != installed
  with_items:
    - name: exa
    - name: fd
      crate: fd-find
    - name: ripgrep
    - name: tac
